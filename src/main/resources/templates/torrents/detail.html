<!-- src/main/resources/templates/torrents/detail.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/import :: import(title=${torrent.title})}">
    <!-- Markdown 渲染 -->
    <script th:src="@{/assets/js/commonmark.min.js}"></script>
    <style>
        .torrent-stats .badge {
            min-width: 100px;
        }

        .file-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .file-list-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header(${user})}"></div>

<main class="container my-4">
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-light">
            <li class="breadcrumb-item"><a th:href="@{/}">首页</a></li>
            <li class="breadcrumb-item"><a th:href="@{/torrents}">种子库</a></li>
            <li class="breadcrumb-item active" th:text="${torrent.title}"></li>
        </ol>
    </nav>

    <!-- 主内容区 -->
    <div class="card shadow-lg">
        <div class="card-body">
            <!-- 标题区 -->
            <div class="mb-4">
                <h2 class="mb-1" th:text="${torrent.title}"></h2>
                <h4 class="text-muted" th:text="${torrent.subtitle}"></h4>
            </div>

            <!-- 上传者信息 -->
            <div class="alert alert-secondary py-2 mb-3" th:unless="${torrent.anonymous}">
                <div class="d-flex align-items-center">
                    <img th:src="@{${torrent.owner.avatar}}"
                         class="rounded-circle mr-3"
                         width="40"
                         alt="上传者头像">
                    <div>
                        <h5 class="mb-0">
                            <span th:text="${torrent.owner.name}"></span>
                            <small class="text-muted ml-2"
                                   th:text="${torrent.owner.primaryPermissionGroup.name}"></small>
                        </h5>
                        <!--                        <div class="text-muted small">-->
                        <!--                            <span>上传: <span th:text="${#numbers.formatDecimal(torrent.owner.uploadedReal, 1, 'COMMA', 2, 'B')}"></span></span>-->
                        <!--                            <span class="mx-2">|</span>-->
                        <!--                            <span>下载: <span th:text="${#numbers.formatDecimal(torrent.owner.downloadedReal, 1, 'COMMA', 2, 'B')}"></span></span>-->
                        <!--                        </div>-->
                    </div>
                </div>
            </div>

            <!-- 统计信息 -->
            <div class="row torrent-stats mb-4">
                <div class="col-md-3 text-center">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="mb-0"
                                th:text="${T(com.ghostchu.tracker.sapling.util.UnitConverter).autoUnit(torrent.size)}"></h5>
                            <small class="text-muted">总大小</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="mb-0" th:text="${torrent.numFiles}"></h5>
                            <small class="text-muted">文件数量</small>
                        </div>
                    </div>
                </div>
                <!--                <div class="col-md-3 text-center">-->
                <!--                    <div class="card bg-success text-white">-->
                <!--                        <div class="card-body">-->
                <!--                            <h5 class="mb-0" th:text="${#maps.get(torrent.extra, 'seeders')}">0</h5>-->
                <!--                            <small>做种人数</small>-->
                <!--                        </div>-->
                <!--                    </div>-->
                <!--                </div>-->
                <!--                <div class="col-md-3 text-center">-->
                <!--                    <div class="card bg-danger text-white">-->
                <!--                        <div class="card-body">-->
                <!--                            <h5 class="mb-0" th:text="${#maps.get(torrent.extra, 'leechers')}">0</h5>-->
                <!--                            <small>下载人数</small>-->
                <!--                        </div>-->
                <!--                    </div>-->
                <!--                </div>-->
            </div>

            <!-- 分类标签 -->
            <div class="mb-4">
                    <span class="badge"
                          th:style="'background-color:' + ${torrent.category.color} + ';color:white'"
                          th:text="${torrent.category.name}"></span>
                <span class="badge badge-secondary ml-2">
                        <i class="fas fa-clock"></i>
                        <span th:text="${#temporals.format(torrent.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                    </span>
            </div>

            <!-- 描述内容 -->
            <div class="mb-4" id="descriptionContent" th:utext="${torrent.description}"></div>

            <!-- 文件列表 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">文件列表</h5>
                </div>
                <!--                <div class="card-body file-list">-->
                <!--                    <div th:each="file : ${#maps.get(torrent.extra, 'files')}"-->
                <!--                         class="file-list-item">-->
                <!--                        <i class="fas fa-file mr-2"></i>-->
                <!--                        <span th:text="${file.name}"></span>-->
                <!--                        <span class="float-right text-muted"-->
                <!--                              th:text="${#numbers.formatDecimal(file.size, 1, 'COMMA', 2, 'B')}"></span>-->
                <!--                    </div>-->
                <!--                </div>-->
            </div>

            <!-- 操作按钮 -->
            <div class="text-center">
                <a th:href="@{/torrents/{id}/download(id=${torrent.id})}"
                   class="btn btn-primary btn-lg mr-3">
                    <i class="fas fa-download mr-2"></i>下载种子
                </a>
                <button class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-star mr-2"></i>加入收藏
                </button>
                <!--                <div th:if="${user.admin}" class="mt-3">-->
                <!--                    <button class="btn btn-danger btn-sm">-->
                <!--                        <i class="fas fa-trash mr-2"></i>删除种子-->
                <!--                    </button>-->
                <!--                </div>-->
            </div>
        </div>
    </div>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Markdown 渲染脚本 -->
<script>
    const reader = new commonmark.Parser();
    const writer = new commonmark.HtmlRenderer();
    const parsed = reader.parse(document.getElementById('descriptionContent').textContent);
    document.getElementById('descriptionContent').innerHTML = writer.render(parsed);
</script>
</body>
</html>